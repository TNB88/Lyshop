<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S·ªï B√°n H√†ng Pro</title>

    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/TNB88/Lyshop/main/photo_2025-11-24_15-49-08.jpg">
    <link rel="icon" href="https://raw.githubusercontent.com/TNB88/Lyshop/main/photo_2025-11-24_15-49-08.jpg">
    <style>
        /* --- CSS GIAO DI·ªÜN CHUNG --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f2f2f7; padding: 15px; margin: 0; color: #333; padding-bottom: 50px; }
        .card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; text-align: center; }
        .total-label { color: #8e8e93; font-size: 14px; text-transform: uppercase; font-weight: 600; }
        .total-value { color: #34C759; font-size: 42px; font-weight: 800; margin: 10px 0; letter-spacing: -1px; }

        /* Input & Layout */
        .input-group { display: flex; gap: 10px; margin-bottom: 12px; }
        input.std-input { flex: 1; padding: 14px; border: 1px solid #d1d1d6; border-radius: 10px; font-size: 17px; background: white; -webkit-appearance: none; }
        input:focus { outline: none; border-color: #007AFF; }
        #inputName { border-left: 5px solid #007AFF; font-weight: 800; color: #007AFF; text-transform: uppercase; }
        
        .box-wrapper { display: flex; align-items: center; border: 1px solid #d1d1d6; border-radius: 10px; background: white; flex: 1; overflow: hidden; }
        .box-label { background-color: #e5e5ea; padding: 14px 10px; font-size: 13px; font-weight: 700; color: #555; border-right: 1px solid #d1d1d6; white-space: nowrap; }
        .box-input { border: none; padding: 14px; width: 100%; font-size: 17px; font-weight: 500; outline: none; -webkit-appearance: none; }

        /* N√∫t Helper (Nh√¢n) */
        .helper-row { display: flex; gap: 10px; margin-bottom: 12px; }
        .btn-helper { flex: 1; padding: 10px; background-color: #E5E5EA; color: #333; border: 1px solid #d1d1d6; border-radius: 8px; font-weight: 600; font-size: 15px; cursor: pointer; }
        .btn-helper:active { background-color: #d1d1d6; }

        /* N√∫t Ch·ª©c NƒÉng */
        button { padding: 14px; border: none; border-radius: 10px; font-weight: 600; font-size: 16px; cursor: pointer; }
        button:active { opacity: 0.7; }
        .btn-add { background-color: #007AFF; color: white; width: 80px; }
        .btn-copy { background-color: #34C759; color: white; width: 100%; margin-top: 15px; font-size: 18px; }
        .btn-print { background-color: #5856D6; color: white; width: 100%; margin-top: 10px; font-size: 18px; }
        .btn-undo { background-color: #8E8E93; color: white; width: 100%; margin-top: 10px; }
        .btn-toggle { background: transparent; color: #007AFF; padding: 5px; margin-left: auto; display: block; font-size: 14px;}

        /* N√∫t Ch·ªët ƒê∆°n M·ªõi */
        .btn-finalize { background-color: #34C759; color: white; width: 100%; margin-top: 10px; font-size: 18px; padding: 16px; box-shadow: 0 4px 10px rgba(52, 199, 89, 0.3); }
        .btn-reset-draft { background-color: #ff3b30; color: white; width: 100%; margin-top: 10px; font-size: 14px; padding: 10px; opacity: 0.8; }

        /* History Box */
        .history-label-row { display: flex; justify-content: space-between; align-items: center; margin: 20px 0 5px 5px; }
        .history-label { font-weight: 600; font-size: 15px; }
        .count-badge { background: #e5e5ea; color: #333; padding: 2px 8px; border-radius: 10px; font-size: 13px; margin-left: 5px; }
        #historyBox { background: white; border: 1px solid #d1d1d6; padding: 15px; border-radius: 10px; font-family: monospace; font-size: 15px; white-space: pre-wrap; line-height: 1.5; color: #333; max-height: 100px; overflow-y: auto; }
        #historyBox.expanded { max-height: 1000px; overflow-y: visible; }

        /* QR Code */
        .qr-container { text-align: center; margin-top: 15px; margin-bottom: 5px; }
        .btn-qr-toggle { background-color: white; color: #007AFF; border: 2px solid #007AFF; padding: 10px 20px; border-radius: 25px; font-size: 15px; font-weight: 700; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.2s; width: 100%; }
        .btn-qr-toggle.active { background-color: #007AFF; color: white; }
        #qrSection { text-align: center; margin-top: 15px; display: none; background: white; padding: 15px; border-radius: 12px; border: 2px dashed #007AFF; animation: fadeIn 0.3s ease; }
        #qrImage { max-width: 100%; height: auto; border-radius: 8px; margin-bottom: 5px; }
        .qr-note { font-size: 13px; color: #666; font-style: italic; }

        /* --- PH·∫¶N DOANH THU (M·ªöI) --- */
        .revenue-section { margin-top: 30px; border-top: 2px dashed #d1d1d6; padding-top: 20px; }
        .revenue-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .revenue-title { font-weight: 800; font-size: 18px; color: #333; text-transform: uppercase; }
        .revenue-total { font-weight: 800; font-size: 20px; color: #FF9500; }
        
        .sales-list { list-style: none; padding: 0; margin: 0; }
        .sale-item { background: white; border-bottom: 1px solid #f0f0f0; padding: 12px; display: flex; justify-content: space-between; align-items: center; }
        .sale-item:first-child { border-top-left-radius: 10px; border-top-right-radius: 10px; }
        .sale-item:last-child { border-bottom-left-radius: 10px; border-bottom-right-radius: 10px; border-bottom: none; }
        
        .sale-info { display: flex; flex-direction: column; }
        .sale-time { font-size: 12px; color: #8e8e93; margin-bottom: 2px; }
        .sale-name { font-weight: 600; font-size: 15px; }
        .sale-money { font-weight: 700; color: #34C759; }
        
        .btn-del-sale { background: #ff3b30; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-left: 10px; cursor: pointer; }
        .btn-clear-sales { background: #8e8e93; color: white; width: 100%; margin-top: 15px; padding: 10px; font-size: 14px; border-radius: 8px; }

        @media print {
            .input-group, .btn-add, .btn-copy, .btn-reset-draft, .btn-undo, .btn-print, .btn-toggle, #qrSection, .qr-container, .helper-row, .btn-finalize, .revenue-section { display: none !important; }
            #historyBox { display: block !important; border: none; max-height: none; font-size: 14px; padding: 0; color: black; }
            #printHeader { display: block !important; text-align: center; margin-bottom: 20px; border-bottom: 1px dashed #000; padding-bottom: 10px; }
        }
        #printHeader { display: none; }
    </style>
</head>
<body>

    <div id="printHeader">
        <h2 style="margin:0">H√ìA ƒê∆†N B√ÅN L·∫∫</h2>
        <div style="font-size: 12px; margin-top:5px;">--- C·∫£m ∆°n qu√Ω kh√°ch ---</div>
    </div>

    <div class="card">
        <div class="total-label">T·ªîNG ƒê∆†N HI·ªÜN T·∫†I</div>
        <div class="total-value" id="displayTotal">0</div>
    </div>

    <div class="input-group">
        <input type="text" class="std-input" id="inputName" placeholder="T√äN KH√ÅCH (VD: CH·ªä LAN)" oninput="calculate()">
    </div>

    <div class="input-group">
        <input type="text" class="std-input" id="inputPrice" placeholder="Gi√° (vd: 170)" inputmode="decimal" pattern="[0-9]*">
        <button class="btn-add" onclick="addItem()">Th√™m</button>
    </div>

    <div class="helper-row">
        <button class="btn-helper" onclick="insertMultiply()">‚úñ NH√ÇN S·ªê L∆Ø·ª¢NG</button>
    </div>

    <div class="input-group">
        <div class="box-wrapper">
            <div class="box-label" style="color: #FF3B30;">- TR·ª™ C·ªåC</div>
            <input type="tel" class="box-input" id="inputDeposit" placeholder="0" inputmode="numeric" oninput="calculate()">
        </div>
        <div class="box-wrapper">
            <div class="box-label" style="color: #007AFF;">+ SHIP</div>
            <input type="tel" class="box-input" id="inputShip" placeholder="0" inputmode="numeric" oninput="calculate()">
        </div>
    </div>

    <div class="history-label-row">
        <div class="history-label">Chi ti·∫øt <span class="count-badge" id="countBadge">0 m√≥n</span>:</div>
        <button id="btnToggle" class="btn-toggle" onclick="toggleView()" style="display:none;">‚ñº Xem ƒë·∫ßy ƒë·ªß</button>
    </div>

    <div id="historyBox"></div>

    <div class="qr-container">
        <button class="btn-qr-toggle" id="btnQrToggle" onclick="toggleQR()">üè¶ L·∫•y M√£ QR</button>
        <div id="qrSection">
            <div style="font-weight: bold; margin-bottom: 5px; color: #007AFF; font-size: 14px;">QU√âT ƒê·ªÇ THANH TO√ÅN</div>
            <img id="qrImage" src="" alt="QR Code" width="220">
            <div class="qr-note">ƒê√∫ng s·ªë ti·ªÅn ‚Ä¢ Kh√¥ng c·∫ßn nh·∫≠p</div>
        </div>
    </div>

    <button class="btn-print" onclick="window.print()">üñ®Ô∏è In H√≥a ƒê∆°n</button>
    <button class="btn-copy" onclick="copyText()">Sao ch√©p g·ª≠i Zalo</button>
    <button class="btn-undo" onclick="undoLast()">X√≥a d√≤ng v·ª´a nh·∫≠p</button>

    <button class="btn-finalize" onclick="finalizeOrder()">‚úÖ CH·ªêT ƒê∆†N & L∆ØU</button>
    <button class="btn-reset-draft" onclick="resetDraftOnly()">üóëÔ∏è X√≥a nh√°p (L√†m l·∫°i)</button>

    <div class="revenue-section">
        <div class="revenue-header">
            <div class="revenue-title">Doanh Thu H√¥m Nay</div>
            <div class="revenue-total" id="dailyTotalDisplay">0</div>
        </div>
        <ul class="sales-list" id="salesList">
            </ul>
        <button class="btn-clear-sales" onclick="clearDailySales()">‚ö†Ô∏è X√≥a s·ªï doanh thu h√¥m nay</button>
    </div>

    <script>
        // ================= C·∫§U H√åNH NG√ÇN H√ÄNG =================
        const MY_BANK_ID = "MB";        
        const MY_ACCOUNT_NUM = "123456789";  
        const MY_NAME = "NGUYEN VAN A"; 
        // ======================================================

        let items = [];
        let itemDetails = []; 
        let itemQuantities = []; 
        let currentTotal = 0;
        let dailySales = []; // M·∫£ng l∆∞u doanh thu

        window.onload = function() {
            loadState();
            loadDailySales();
        };

        // --- 1. X·ª¨ L√ù DOANH THU (S·ªî C√ÅI) ---
        function finalizeOrder() {
            if (currentTotal <= 0) {
                alert("ƒê∆°n 0ƒë th√¨ ch·ªët l√†m g√¨ b·∫°n ∆°i!");
                return;
            }

            const name = document.getElementById('inputName').value.trim() || "Kh√°ch L·∫ª";
            const now = new Date();
            const timeString = now.getHours() + ":" + String(now.getMinutes()).padStart(2, '0');

            // T·∫°o object ƒë∆°n h√†ng
            const order = {
                id: Date.now(), // ID duy nh·∫•t
                time: timeString,
                name: name,
                total: currentTotal
            };

            // L∆∞u v√†o m·∫£ng doanh thu
            dailySales.push(order);
            saveDailySalesToStorage();
            updateRevenueUI();

            // Reset nh√°p ƒë·ªÉ nh·∫≠p ƒë∆°n m·ªõi
            alert(`ƒê√£ ch·ªët ƒë∆°n c·ªßa ${name}: ${formatMoney(currentTotal)}ƒë`);
            resetDraftLogic(true); // true = silent reset
        }

        function updateRevenueUI() {
            const listEl = document.getElementById('salesList');
            const totalEl = document.getElementById('dailyTotalDisplay');
            
            let sum = 0;
            let html = "";

            // Duy·ªát danh s√°ch ng∆∞·ª£c (m·ªõi nh·∫•t l√™n ƒë·∫ßu)
            [...dailySales].reverse().forEach(order => {
                sum += order.total;
                html += `
                    <li class="sale-item">
                        <div class="sale-info">
                            <span class="sale-time">${order.time} - ${order.name}</span>
                            <span class="sale-money">+ ${formatMoney(order.total)}</span>
                        </div>
                        <button class="btn-del-sale" onclick="deleteSale(${order.id})">X√≥a</button>
                    </li>
                `;
            });

            listEl.innerHTML = html;
            totalEl.innerText = formatMoney(sum);
        }

        function deleteSale(id) {
            if(confirm("B·∫°n mu·ªën x√≥a ƒë∆°n n√†y kh·ªèi doanh thu?")) {
                dailySales = dailySales.filter(o => o.id !== id);
                saveDailySalesToStorage();
                updateRevenueUI();
            }
        }

        function clearDailySales() {
            if(confirm("X√ìA S·∫†CH DOANH THU H√îM NAY?\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!")) {
                dailySales = [];
                saveDailySalesToStorage();
                updateRevenueUI();
            }
        }

        function saveDailySalesToStorage() {
            localStorage.setItem('dailySales', JSON.stringify(dailySales));
        }

        function loadDailySales() {
            const saved = localStorage.getItem('dailySales');
            if(saved) {
                dailySales = JSON.parse(saved);
                updateRevenueUI();
            }
        }
        // ----------------------------------------

        // --- 2. LOGIC T√çNH TO√ÅN C∆† B·∫¢N ---
        function saveState() {
            const state = {
                items: items, itemDetails: itemDetails, itemQuantities: itemQuantities,
                name: document.getElementById('inputName').value,
                deposit: document.getElementById('inputDeposit').value,
                ship: document.getElementById('inputShip').value
            };
            localStorage.setItem('billState', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('billState');
            if (saved) {
                try {
                    const state = JSON.parse(saved);
                    items = state.items || [];
                    itemDetails = state.itemDetails || items.map(x => formatMoney(x)); 
                    itemQuantities = state.itemQuantities || items.map(() => 1);
                    document.getElementById('inputName').value = state.name || "";
                    document.getElementById('inputDeposit').value = state.deposit || "";
                    document.getElementById('inputShip').value = state.ship || "";
                    calculate(false); 
                } catch (e) { console.error(e); }
            }
        }

        const formatMoney = (num) => {
            if (!num && num !== 0) return "0";
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        };

        function calculate(shouldSave = true) {
            const name = document.getElementById('inputName').value.toUpperCase();
            const deposit = parseInt(document.getElementById('inputDeposit').value.replace(/\./g, '')) || 0;
            const ship = parseInt(document.getElementById('inputShip').value.replace(/\./g, '')) || 0;
            const sumItems = items.reduce((a, b) => a + b, 0);
            const totalQty = itemQuantities.reduce((a, b) => a + b, 0);
            
            const finalShort = sumItems - deposit + ship;
            currentTotal = finalShort * 1000; 

            document.getElementById('displayTotal').innerText = formatMoney(currentTotal);
            document.getElementById('countBadge').innerText = totalQty + " m√≥n";

            if (currentTotal > 0) {
                const content = `TTOAN ${name}`.trim();
                const qrUrl = `https://img.vietqr.io/image/${MY_BANK_ID}-${MY_ACCOUNT_NUM}-compact2.png?amount=${currentTotal}&addInfo=${encodeURIComponent(content)}&accountName=${encodeURIComponent(MY_NAME)}`;
                document.getElementById('qrImage').src = qrUrl;
            } else {
                document.getElementById('qrSection').style.display = "none";
                document.getElementById('btnQrToggle').classList.remove('active');
                document.getElementById('btnQrToggle').innerText = "üè¶ L·∫•y M√£ QR";
            }

            let historyText = "";
            if (name.trim() !== "") historyText += `KH√ÅCH H√ÄNG: ${name}\n----------------\n`;

            if (items.length > 0) {
                historyText += itemDetails.join(" + ");
                if (deposit > 0 || ship > 0) {
                    historyText += `\n= ${formatMoney(sumItems)} (T·ªïng h√†ng)`;
                    if (deposit > 0) historyText += `\n- ${formatMoney(deposit)} (ƒê√É TR·ª™ C·ªåC)`;
                    if (ship > 0) historyText += `\n+ ${formatMoney(ship)} (PH√ç SHIP)`;
                    historyText += `\n= ${formatMoney(currentTotal)} (C√íN L·∫†I)`;
                } else {
                    historyText += `\n= ${formatMoney(sumItems)}`;
                }
                historyText += `\n\nT·ªîNG THANH TO√ÅN: ${formatMoney(currentTotal)} VNƒê`;
                document.getElementById('btnToggle').style.display = "block";
            } else {
                document.getElementById('btnToggle').style.display = "none";
            }
            document.getElementById('historyBox').innerText = historyText;
            if(shouldSave) saveState();
        }

        function insertMultiply() {
            const input = document.getElementById('inputPrice');
            const currentVal = input.value;
            if (currentVal && !currentVal.includes('x')) {
                input.value = currentVal + "x";
                input.focus();
            }
        }

        function toggleQR() {
            const qrSection = document.getElementById('qrSection');
            const btn = document.getElementById('btnQrToggle');
            if (currentTotal <= 0) { alert("ƒê∆°n 0ƒë th√¨ kh√¥ng t·∫°o QR ƒë∆∞·ª£c nh√©!"); return; }
            if (qrSection.style.display === "none" || qrSection.style.display === "") {
                qrSection.style.display = "block"; btn.innerText = "·∫®n M√£ QR"; btn.classList.add('active'); qrSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else { qrSection.style.display = "none"; btn.innerText = "üè¶ L·∫•y M√£ QR"; btn.classList.remove('active'); }
        }

        function toggleView() {
            const box = document.getElementById('historyBox');
            const btn = document.getElementById('btnToggle');
            box.classList.toggle('expanded');
            btn.innerText = box.classList.contains('expanded') ? "‚ñ≤ Thu g·ªçn" : "‚ñº Xem ƒë·∫ßy ƒë·ªß";
        }

        function addItem() {
            const input = document.getElementById('inputPrice');
            let rawVal = input.value.trim();
            rawVal = rawVal.replace(/x/g, '*').replace(/X/g, '*').replace(/ /g, '*');

            let finalVal = 0;
            let displayStr = "";
            let currentQty = 1;

            if (rawVal.includes('*')) {
                const parts = rawVal.split('*');
                const price = parseInt(parts[0].replace(/\./g, ''));
                const qty = parseInt(parts[1]);

                if (!isNaN(price) && !isNaN(qty) && price > 0 && qty > 0) {
                    finalVal = price * qty;
                    displayStr = `${formatMoney(price)}x${qty}`; 
                    currentQty = qty;
                }
            } else {
                finalVal = parseInt(rawVal.replace(/\./g, ''));
                if (!isNaN(finalVal) && finalVal > 0) {
                    displayStr = formatMoney(finalVal);
                    currentQty = 1;
                }
            }

            if (finalVal > 0 && displayStr !== "") {
                items.push(finalVal);
                itemDetails.push(displayStr);
                itemQuantities.push(currentQty); 
                input.value = "";
                calculate();
                input.focus();
            }
        }

        function undoLast() {
            if (items.length > 0) { items.pop(); itemDetails.pop(); itemQuantities.pop(); calculate(); }
        }

        function resetDraftOnly() {
            if(confirm("X√≥a nh√°p ƒë·ªÉ l√†m l·∫°i (Kh√¥ng l∆∞u doanh thu)?")) {
                resetDraftLogic();
            }
        }

        function resetDraftLogic(isSilent = false) {
            items = []; itemDetails = []; itemQuantities = []; currentTotal = 0;
            document.getElementById('inputName').value = "";
            document.getElementById('inputPrice').value = "";
            document.getElementById('inputDeposit').value = "";
            document.getElementById('inputShip').value = "";
            calculate(false); 
            document.getElementById('displayTotal').innerText = "0";
            document.getElementById('historyBox').innerText = "";
            localStorage.removeItem('billState');
            
            // ·∫®n QR khi reset
            document.getElementById('qrSection').style.display = "none";
            document.getElementById('btnQrToggle').classList.remove('active');
            document.getElementById('btnQrToggle').innerText = "üè¶ L·∫•y M√£ QR";
        }

        function copyText() {
            const text = document.getElementById('historyBox').innerText;
            if(text) {
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(text).then(() => {
                        const name = document.getElementById('inputName').value.toUpperCase();
                        alert("ƒê√£ sao ch√©p ƒë∆°n c·ªßa: " + (name || "KH√ÅCH"));
                    });
                } else {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed"; document.body.appendChild(textArea); textArea.focus(); textArea.select();
                    try { document.execCommand('copy'); alert("ƒê√£ sao ch√©p!"); } catch (err) { alert("L·ªói sao ch√©p."); }
                    document.body.removeChild(textArea);
                }
            } else { alert("Ch∆∞a c√≥ d·ªØ li·ªáu!"); }
        }

        document.getElementById("inputPrice").addEventListener("keypress", function(event) {
            if (event.key === "Enter") addItem();
        });
    </script>
</body>
</html>
